<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NextEFB</title>
    <link rel="stylesheet" href="style.css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<div
        id="map"

></div>
<script>
    mapboxgl.accessToken = "pk.eyJ1Ijoid2lsbGRpbGwxMzExIiwiYSI6ImNranBkdHVmZTB4b2kycHBlb2lkcnFkeTQifQ.gW4hSXXUo4AdSYF3OUZMNA";
    const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/dark-v10",
        zoom: 6,
        center: [-100, 47]
    });

    window.map = map;

    map.on("load", () => {
        fetch("https://api.rainviewer.com/public/weather-maps.json")
            .then(res => res.json())
            .then(apiData => {
                apiData.radar.past.forEach(frame => {
                    map.addLayer({
                        id: `rainviewer_${frame.path}`,
                        type: "raster",
                        source: {
                            type: "raster",
                            tiles: [
                                apiData.host + frame.path + '/256/{z}/{x}/{y}/2/1_1.png'
                            ],
                            tileSize: 256
                        },
                        layout: { visibility: "none" },
                        minzoom: 0,
                        maxzoom: 12
                    });
                });

                let i = 0;
                const interval = setInterval(() => {
                    if (i > apiData.radar.past.length - 1) {
                        clearInterval(interval);
                        return;
                    } else {
                        apiData.radar.past.forEach((frame, index) => {
                            map.setLayoutProperty(
                                `rainviewer_${frame.path}`,
                                "visibility",
                                index === i || index === i - 1 ? "visible" : "none"
                            );
                        });
                        if (i - 1 >= 0) {
                            const frame = apiData.radar.past[i - 1];
                            let opacity = 1;
                            setTimeout(() => {
                                const i2 = setInterval(() => {
                                    if (opacity <= 0) {
                                        return clearInterval(i2);
                                    }
                                    map.setPaintProperty(
                                        `rainviewer_${frame.path}`,
                                        "raster-opacity",
                                        opacity
                                    );
                                    opacity -= 0.1;
                                }, 50);
                            }, 400);
                        }
                        i += 1;
                    }
                }, 2000);
            })
            .catch(console.error);
    });
</script>
<a href="index.html" target="blank">
    <button class="home_button" type="button" ></button>
</a>
</body>
</html>